import geopandas as gpd
import pandas as pd
import plotly.express as px

# Read in the vulnerability layer
texas_vulnerability_shp = gpd.read_file(r"C:\Users\holtc\HAC-GEOG676-Lab\Projects\overall_shapefile_for_walker.shp")
texas_vulnerability_csv = pd.read_csv(r"C:\Users\holtc\HAC-GEOG676-Lab\Projects\output_joined_for_walker.csv")

# Merge the shapefile and CSV
merged_vulnerability_data = texas_vulnerability_shp.merge(texas_vulnerability_csv, on="COUNTY")

# new classification logic: Based on 'overall_svi' range (0-1)
def severity_classification(svi):
    if svi <= 0.2:
        return "None"
    elif svi <= 0.4:
        return "Low"
    elif svi <= 0.6:
        return "Moderate"
    elif svi <= 0.8:
        return "High"
    elif svi <= 0.95:
        return "Severe"
    else:
        return "Critical"

# classification to the merged dataset
merged_vulnerability_data["Most_Severe_Level"] = merged_vulnerability_data["overall_svi"].apply(severity_classification)

geojson_vulnerability = merged_vulnerability_data.__geo_interface__

# Map generation
texas_vulnerability_map = px.choropleth_mapbox(
    merged_vulnerability_data,
    geojson=geojson_vulnerability,
    locations="COUNTY",
    color="Most_Severe_Level",
    featureidkey="properties.COUNTY",
    mapbox_style="carto-positron",
    center={"lat": 31.9686, "lon": -99.9018},
    zoom=5,
    color_discrete_map={
        "None": "green",
        "Low": "yellow",
        "Moderate": "orange",
        "High": "red",
        "Severe": "firebrick",
        "Critical": "darkred",
    },
    category_orders={
        "Most_Severe_Level": ["None", "Low", "Moderate", "High", "Severe", "Critical"],
    },
    title="Vulnerability to Drought in 2023 by County"
)

# Update map layout
texas_vulnerability_map.update_layout(
    title={
        "text": "Texas Drought Vulnerability 2023",
        "x": 0.5,
        "y": 0.975,
        "xanchor": "center",
        "yanchor": "top",
        "font": {"size": 22},
        "pad": {"t": 10},
    },
    legend={
        "title": {"text": "Vulnerability Levels"},
        "yanchor": "bottom",
        "y": 0.027,
        "xanchor": "left",
        "x": 0.01,
    },
    margin={"r": 10, "t": 75, "l": 10, "b": 0},
    mapbox={
        "center": {"lat": 31.3, "lon": -99.9},
        "zoom": 4.6,
    },
)

texas_vulnerability_map.show()
